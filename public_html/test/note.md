#【計測プログラム作成演習】

4年生の課題用にデジタル・マルチメータ VOAC7521A を設置しました。
IPアドレスは 192.168.29.7 です。TCP/IPで測定値を取得できます。

取扱説明書は Dropbox の「地域課題・PINOT2018\プログラミング課題」
に置きました。

現在、9-1の部屋の前に設置している防犯カメラ装置(Raspberry Pi)の
電流値をこの測定器で常時測定しています。

1. ssh.cs.ehime-u.ac.jp でC言語を用いてプログラム開発を行うこと
2. 電流値を1秒おきに読み込んで、時刻と電流値をファイルに保存すること。
    ファイル名は 20180628.csv のようにすること。
3. 上記の機器は同時に複数のTCP/IPのコネクションに対応していないため、
    他の人も同時に課題が行えるよう、測定1回ごとに一旦コネクション
    を切断し、1秒おきに再接続すること。
4. 1秒おきに電流値を保存できるようになったら、9-1の部屋の前に行き、
    1分ほど部屋の前に立つこと。下記のステップに応じて電流値が変化
    するので、その電流値の変化をブラウザで閲覧できるようにすること。
    (i) 人が来るとUSBカメラが起動して録画を開始します。
    (ii) 人がいなくなると録画を終え、avi形式からmp4形式に変換します。
    (iii) mp4形式に変換後、ファイルサーバーにアップロードします。

    各自のURLは下記のとおりとする。

    太田 http://ssh.cs.ehime-u.ac.jp/~e1508ohta/test/
    尾崎 http://ssh.cs.ehime-u.ac.jp/~e1514ozak/test/
    中山 http://ssh.cs.ehime-u.ac.jp/~e1589naka/test/
    平澤 http://ssh.cs.ehime-u.ac.jp/~e1560hira/test/
    横田 http://ssh.cs.ehime-u.ac.jp/~e1580yoko/test/




## client.c
以下の手順でリモートのサーバと通信し、データを取得します。

gethostbyname()によりドメイン名からIPアドレスを引く
socket() によりソケットを開く
connect() によりサーバに接続する
write() でサーバにリクエストを送る
read() でレスポンスを受信する
close() によりソケットを閉じる
http://blog.majide.com/2009/02/socket-programming-client/
* テストコード
curl -H ":MAIN:DATA?" 192.168.29.7:2000


# 重要
4.5 通信方式 本製品とPCとの通信は、TCP/IPを利用します。TCP/IP接続は以下の手順で行なわれます。
手順
1. 電源投入後、本製品は設定されたポート番号で、外部機器からのTCP / IPの接続要求を待ちま す。
2. 外部機器は、本製品に対してTCP / IP接続要求を出します。
3. 本製品がTCP / IP接続要求を受け付け、接続を確立します。
4. TCP / IPの接続確立後は、単純な7bit ASCIIコードの文字列の送受信で通信を行ないます。
5. PC=>本製品方向にコマンド又はクエリを送信します。
コマンド / クエリメッセージは、CR+LFまたはLFで終端された文字列です。
6. コマンド / クエリを受信した本製品はこれを解釈、実行し、クエリであればPCに対して応答メ
ッセージを返します。 応答メッセージは設定したデリミタ(CR+LFまたはLF)を付加した文字列です。
尚、本製品と同時に接続可能なPCの数は1台のみです。


  例)“+5.09999E+1” 図4.3 PCと本製品の通信イメージ

## メッセージフォーマット
  1個のメッセージユニットは、ヘッダ部とデータ部と両者を区切るヘッダセパレータとで構成され ます。
(例):MAIN:FUNC ON
ヘッダ部(ヘッダセパレータ:スペース) データ部

### ヘッダ部 
ヘッダ部はASCII文字で構成されます。コロン(:)で区切られた1から3個のニーモニックから 成り、本製品の機能あるいは動作を表します。 上記は本製品の設定を行うためのコマンドの例であり、設定内容を問い合わせる(本製品に応 答データを作成させる)クエリの場合には、ヘッダ部の最後の文字が?マークとなります。

### データ部 
データ部は、ヘッダ部で指定した機能の、具体的な設定内容を示すパラメータです。ニーモニ ック(文字列)で構成される場合もあれば、数値で構成されることもあります。 複数のパラメータを必要とする場合には、各々のパラメータのセパレータとしてカンマ(,)を 使用します。 パラメータの個数や、その構成はコマンドごとに異なります。データ部の詳細なフォーマット については、それぞれのコマンドの説明をご参照下さい。

## マルチコマンド
複数のメッセージユニットを集めて1個のメッセージとして構成することができます。 各メッセージユニットをセミコロン(;)で区切ってつなげます。 (例):MAIN:DCBL:STAT ON ; :MAIN:DCBL:MOD ON




## レスポンス

DCA_,___,___,+00.287E+0,14890168
Func,（Err(Calc)）,Type,Value,TimeStamp

* Func = FUNCTION情報フィールド
* Err(Calc) = エラー / 演算情報フィールド
* type = 統計データ種別フィールド
* 測定値フィールド（Value）
* タイムスタンプフィールド（TimeStamp）


### 文字列 定義
“DCV_” 直流電圧測定
“ACV_” 交流電圧測定
“OHM_” 2端子抵抗測定
“DCA_” 直流電流測定
“ACA_” 交流電流測定
“TEMP” 温度測定
“BCH_” CH-B直流電圧測定 注1）
“FREQ” 周波数測定
“DAV_” （直流+交流）電圧測定
“DAA_” （直流+交流）電流測定
“LOHM” ローパワー抵抗測定
“O4W_” 4端子抵抗測定 注2）
“DIOD” ダイオード測定


・エラー発生時
文字列 定義
“OL_” オーバロード
“OF_” スケーリング演算
オーバフロー
“LZ_” デシベル演算 Log（0）
“ND_” No Data （※1）
※1 No Dataは、以下の条件です。
・電源投入直後1回も測定されていない状態でのDATA?クエリ
・統計サンプル数未達時のDATA? / MEAS?クエリ
・保存されていないアドレスからの:RCLL:DATA?クエリ

・エラーがない時
文字列 スケーリング演算 デシベル演算 差分演算
“_ _ _” OFF OFF OFF
“S_ _” ON OFF OFF
“_D_” OFF ON OFF
“SD_” ON ON OFF
“_ _R” OFF OFF ON
“S_R” ON OFF ON
“_DR” OFF ON ON
“SDR” ON ON ON

文字列 定義
“_ _ _” Raw（生）データ
“MAX” 最大値
“MIN” 最小値
“AVG” 移動平均値
“SIG” 標準偏差σ

測定値フィールド（Value）
測定値そのものを表し、可変長（Max12）文字

タイムスタンプフィールド（TimeStamp）
電源投入からの経過時間を示すタイムスタンプで、最大10文字の正整数です。1カウントが10msec
に相当します。
この値を日、時、分、秒に変換するのは以下の単純な計算式によります。
単位 変換式
日 タイムスタンプのカウント数 / 8640000
時 （タイムスタンプのカウント数 / 360000） ％ 24
分 （タイムスタンプのカウント数 / 6000） ％ 60
秒 （タイムスタンプのカウント数 / 100） ％ 60
ミリ秒 (タイムスタンプのカウント数 ％ 100)＊10
注）変換式内の“a％b”は、a / bの余りを示します。


